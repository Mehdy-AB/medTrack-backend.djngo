# Complete Inter-Service Testing Guide - medTrack Backend

## ğŸ—ï¸ Service Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚     â”‚              â”‚     â”‚             â”‚
â”‚  Traefik    â”‚â”€â”€â”€â”€â–¶â”‚   Consul     â”‚â—€â”€â”€â”€â”€â”‚  RabbitMQ   â”‚
â”‚  (Gateway)  â”‚     â”‚  (Discovery) â”‚     â”‚  (Events)   â”‚
â”‚ :80         â”‚     â”‚ :8500        â”‚     â”‚ :5672       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚
       â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚            â”‚                â”‚            â”‚            â”‚
       â–¼            â–¼                â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Auth        â”‚ Profile     â”‚ Core        â”‚ Eval        â”‚ Comm        â”‚
â”‚ Service     â”‚ Service     â”‚ Service     â”‚ Service     â”‚ Service     â”‚
â”‚ :8000       â”‚ :8000       â”‚ :8000       â”‚ :8000       â”‚ :8000       â”‚
â”‚             â”‚             â”‚             â”‚             â”‚             â”‚
â”‚ - Users     â”‚ - Profiles  â”‚ - Offers    â”‚ - Attendanceâ”‚ - Emails    â”‚
â”‚ - JWT       â”‚ - Students  â”‚ - Apps      â”‚ - Evals     â”‚ - Notifs    â”‚
â”‚ - Roles     â”‚ - Encadrantsâ”‚ - Affect    â”‚             â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                      â”‚  PostgreSQL â”‚
                      â”‚  :5432      â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— Service Dependencies (via Consul)

### **Core-Service Dependencies:**
```
Core-Service needs:
â”œâ”€ Auth-Service (Consul)
â”‚  â””â”€ Verify user exists, get user details
â”œâ”€ Profile-Service (Consul)
â”‚  â””â”€ Get student/encadrant profile data
â””â”€ Eval-Service (Consul)
   â””â”€ Create attendance summaries on affectation
```

### **Eval-Service Dependencies:**
```
Eval-Service needs:
â”œâ”€ Auth-Service (Consul)
â”‚  â””â”€ Verify user roles, get user info
â”œâ”€ Profile-Service (Consul)
â”‚  â””â”€ Get student/encadrant details for evaluations
â””â”€ Core-Service (Consul)
   â””â”€ Validate affectation_id, get offer details
```

---

## ğŸ“Š All Available APIs

### **1. Auth-Service (`/auth`)**

```http
# Register User
POST /auth/register
{
  "email": "user@example.com",
  "password": "Test123!",
  "first_name": "John",
  "last_name": "Doe",
  "role": "student|encadrant|admin"
}

# Login  
POST /auth/login
{
  "email": "user@example.com",
  "password": "Test123!"
}
Response: { "access_token": "...", "refresh_token": "..." }

# Refresh Token
POST /auth/refresh
{
  "refresh_token": "..."
}

# Get Current User
GET /auth/me
Authorization: Bearer {token}

# Update Profile
PATCH /auth/me
Authorization: Bearer {token}
{
  "first_name": "Updated",
  "last_name": "Name"
}
```

---

### **2. Profile-Service (`/profile`)**

```http
# Get All Profiles
GET /profile/profiles/
Authorization: Bearer {token}

# Get Specific Profile
GET /profile/profiles/{user_id}/
Authorization: Bearer {token}

# Create Profile
POST /profile/profiles/
Authorization: Bearer {token}
{
  "user_id": "uuid",
  "phone": "0612345678",
  "speciality": "Cardiology"  # For encadrants
}

# Get Students List
GET /profile/students/
Authorization: Bearer {encadrant-token}

# Get Encadrants List
GET /profile/encadrants/
Authorization: Bearer {admin-token}
```

---

### **3. Core-Service (`/core`)**

#### **Offers:**
```http
GET    /core/offers/              # List all offers
GET    /core/offers/{id}/         # Get offer details
POST   /core/offers/              # Create offer (encadrant/admin)
PUT    /core/offers/{id}/         # Update offer
PATCH  /core/offers/{id}/status/  # Change status (published/closed)
DELETE /core/offers/{id}/         # Delete offer
```

#### **Applications:**
```http
GET    /core/applications/             # List applications
POST   /core/applications/             # Student applies to offer
GET    /core/applications/{id}/        # Get application details
PATCH  /core/applications/{id}/status/ # Accept/reject (encadrant/admin)
DELETE /core/applications/{id}/        # Cancel application
```

#### **Affectations:**
```http
GET    /core/affectations/        # List affectations
GET    /core/affectations/{id}/   # Get affectation details
POST   /core/affectations/        # Create manual affectation (admin)
```

---

### **4. Eval-Service (`/eval`)**

#### **Attendance:**
```http
POST   /eval/attendance/                   # Mark attendance
GET    /eval/attendance/                   # List attendance records
POST   /eval/attendance/bulk-mark/         # Mark multiple

GET    /eval/attendance-summary/           # Get summaries
POST   /eval/attendance-summary/{id}/validate/  # Validate (encadrant)
```

#### **Evaluations:**
```http
POST   /eval/evaluations/                  # Submit evaluation
GET    /eval/evaluations/                  # List evaluations
GET    /eval/evaluations/{id}/             # Get evaluation details
PUT    /eval/evaluations/{id}/             # Update evaluation
POST   /eval/evaluations/{id}/validate/    # Validate (encadrant/admin)
```

---

## ğŸ§ª Complete Testing Flow (All Services)

### **Prerequisites:**
1. All services running: `docker-compose ps` (should show all healthy)
2. Consul UI: `http://localhost:8500` (check all services registered)
3. RabbitMQ UI: `http://localhost:15672` (admin/password)

---

### **Phase 1: Setup Users (Auth + Profile)**

#### **Step 1.1: Register Encadrant**
```http
POST http://localhost/auth/register
Content-Type: application/json

{
  "email": "dr.ahmed@medtrack.com",
  "password": "Test123!",
  "first_name": "Ahmed",
  "last_name": "Bennani",
  "role": "encadrant"
}
```

**Response:** User created with [user_id](file:///c:/Users/pc/Desktop/medTrack-backend.djngo/services/core-service/src/utils/rbac.py#25-31)

---

#### **Step 1.2: Create Encadrant Profile**
```http
POST http://localhost/profile/profiles/
Authorization: Bearer {encadrant-token from login}
Content-Type: application/json

{
  "user_id": "{encadrant-user-id}",
  "phone": "0661234567",
  "speciality": "Cardiology",
  "department": "Cardio Unit",
  "hospital_name": "CHU Rabat"
}
```

---

#### **Step 1.3: Register Student**
```http
POST http://localhost/auth/register
Content-Type: application/json

{
  "email": "sara.alami@medtrack.com",
  "password": "Test123!",
  "first_name": "Sara",
  "last_name": "Alami",
  "role": "student"
}
```

---

#### **Step 1.4: Create Student Profile**
```http
POST http://localhost/profile/profiles/
Authorization: Bearer {student-token}
Content-Type: application/json

{
  "user_id": "{student-user-id}",
  "phone": "0671234567",
  "academic_year": "6th year",
  "university": "Faculty of Medicine, Rabat"
}
```

---

### **Phase 2: Test Core-Service with Dependencies**

#### **Step 2.1: Encadrant Creates Offer**
```http
POST http://localhost/core/offers/
Authorization: Bearer {ENCADRANT_TOKEN}
Content-Type: application/json

{
  "title": "Cardiology Rotation - CHU Rabat",
  "description": "6-month internship in cardiology department",
  "service_id": "bbbbbbbb-2222-2222-2222-222222222222",
  "establishment_id": "cccccccc-3333-3333-3333-333333333333",
  "period_start": "2025-01-01",
  "period_end": "2025-06-30",
  "available_slots": 3
}
```

**What Happens Behind the Scenes:**
1. âœ… Core-service validates JWT via middleware
2. âœ… Checks RBAC (encadrant role)
3. âœ… Uses Consul to call Profile-service â†’ verify encadrant exists
4. âœ… Creates offer in database
5. âœ… Publishes `core.offer.created` event to RabbitMQ

**Save the offer [id](file:///c:/Users/pc/Desktop/medTrack-backend.djngo/services/core-service/src/offers/serializers.py#31-48)!**

---

#### **Step 2.2: Publish Offer**
```http
PATCH http://localhost/core/offers/{OFFER_ID}/status/
Authorization: Bearer {ENCADRANT_TOKEN}
Content-Type: application/json

{
  "status": "published"
}
```

**Behind the Scenes:**
1. âœ… Validates user is offer creator or admin/encadrant
2. âœ… Updates status
3. âœ… Publishes `core.offer.published` event
4. âœ… COMM-service consumer sends email notifications
5. âœ… PROFILE-service consumer updates offer index

---

#### **Step 2.3: Student Applies**
```http
POST http://localhost/core/applications/
Authorization: Bearer {STUDENT_TOKEN}
Content-Type: application/json

{
  "offer_id": "{OFFER_ID}",
  "motivation_letter": "I am passionate about cardiology and would love to join this rotation to enhance my clinical skills..."
}
```

**Behind the Scenes:**
1. âœ… Core-service uses Consul to call Profile-service â†’ verify student profile exists
2. âœ… Validates offer is published and has slots
3. âœ… Creates application
4. âœ… Publishes `core.application.submitted` event

**Save application [id](file:///c:/Users/pc/Desktop/medTrack-backend.djngo/services/core-service/src/offers/serializers.py#31-48)!**

---

#### **Step 2.4: Encadrant Accepts Application**
```http
PATCH http://localhost/core/applications/{APP_ID}/status/
Authorization: Bearer {ENCADRANT_TOKEN}
Content-Type: application/json

{
  "status": "accepted",
  "notes": "Excellent motivation letter"
}
```

**Behind the Scenes:**
1. âœ… RBAC check (only encadrant/admin)
2. âœ… Validates offer has available slots
3. âœ… Updates application status
4. âœ… **Auto-creates Affectation**
5. âœ… Publishes `core.application.accepted` event
6. âœ… Publishes `core.affectation.created` event
7. âœ… **Eval-service consumer creates AttendanceSummary** 

**Save affectation [id](file:///c:/Users/pc/Desktop/medTrack-backend.djngo/services/core-service/src/offers/serializers.py#31-48)!**

---

### **Phase 3: Test Eval-Service with Dependencies**

#### **Step 3.1: Student Marks Attendance**
```http
POST http://localhost/eval/attendance/
Authorization: Bearer {STUDENT_TOKEN}
Content-Type: application/json

{
  "affectation_id": "{AFFECTATION_ID}",
  "date": "2025-01-15",
  "status": "present",
  "hours": 8
}
```

**Behind the Scenes:**
1. âœ… Eval-service uses Consul to call Core-service â†’ verify affectation exists
2. âœ… Checks student_id matches affectation
3. âœ… Creates attendance record
4. âœ… Updates AttendanceSummary (present_count++)
5. âœ… Publishes `eval.attendance.marked` event

---

#### **Step 3.2: Check Attendance Summary**
```http
GET http://localhost/eval/attendance-summary/?affectation_id={AFFECTATION_ID}
Authorization: Bearer {STUDENT_TOKEN}
```

**Response:**
```json
{
  "affectation_id": "...",
  "student_id": "...",
  "total_days": 5,
  "present_count": 5,
  "absent_count": 0,
  "late_count": 0,
  "attendance_rate": 100.0
}
```

---

#### **Step 3.3: Student Submits Evaluation**
```http
POST http://localhost/eval/evaluations/
Authorization: Bearer {STUDENT_TOKEN}
Content-Type: application/json

{
  "affectation_id": "{AFFECTATION_ID}",
  "evaluation_type": "mid_term",
  "comment": "Great learning experience. The team is very supportive.",
  "sections": [
    {
      "section_name": "Clinical Skills",
      "score": 85,
      "comment": "Good diagnostic skills"
    },
    {
      "section_name": "Professionalism",
      "score": 90,
      "comment": "Excellent interaction with patients"
    }
  ]
}
```

**Behind the Scenes:**
1. âœ… Eval-service uses Consul to call Core-service â†’ verify affectation
2. âœ… Uses Consul to call Profile-service â†’ get student details
3. âœ… Creates evaluation with sections
4. âœ… Publishes `eval.evaluation.submitted` event

**Save evaluation [id](file:///c:/Users/pc/Desktop/medTrack-backend.djngo/services/core-service/src/offers/serializers.py#31-48)!**

---

#### **Step 3.4: Encadrant Validates Evaluation**
```http
POST http://localhost/eval/evaluations/{EVAL_ID}/validate/
Authorization: Bearer {ENCADRANT_TOKEN}
Content-Type: application/json

{
  "validated": true
}
```

**Behind the Scenes:**
1. âœ… RBAC check (only encadrant/admin)
2. âœ… Updates validated status and timestamp
3. âœ… Publishes `eval.evaluation.validated` event
4. âœ… COMM-service sends confirmation email to student

---

## ğŸ” Testing Consul Service Discovery

### **Verify Services Registered:**
```http
GET http://localhost:8500/v1/catalog/services
```

**Expected:**
```json
{
  "auth-service": [],
  "profile-service": [],
  "core-service": [],
  "eval-service": [],
  "consul": []
}
```

---

### **Check Service Health:**
```http
GET http://localhost:8500/v1/health/service/core-service
```

**Expected:** Status "passing"

---

## ğŸ¯ RBAC Testing Matrix

| Endpoint | Student | Encadrant | Admin | Expected |
|----------|---------|-----------|-------|----------|
| POST /core/offers/ | âŒ | âœ… | âœ… | Student gets 403 |
| PATCH /core/offers/{id}/status/ | âŒ | âœ… | âœ… | Student gets 403 |
| POST /core/applications/ | âœ… | âœ… | âœ… | All can apply |
| PATCH /core/applications/{id}/status/ | âŒ | âœ… | âœ… | Student gets 403 |
| POST /eval/attendance/ | âœ… | âœ… | âœ… | All can mark |
| POST /eval/attendance-summary/{id}/validate/ | âŒ | âœ… | âœ… | Student gets 403 |
| POST /eval/evaluations/{id}/validate/ | âŒ | âœ… | âœ… | Student gets 403 |

---

## ğŸ› Troubleshooting

### **Issue: 503 Service Unavailable**
**Cause:** Target service not registered in Consul  
**Fix:**
```bash
# Check services in Consul
curl http://localhost:8500/v1/catalog/services

# Restart service
docker-compose restart core-service
```

---

### **Issue: 403 Forbidden on Valid Request**
**Cause:** Wrong role in JWT token  
**Fix:** Check token payload:
```bash
# Decode JWT at https://jwt.io
# Verify "role" field matches required role
```

---

### **Issue: Events Not Received**
**Cause:** RabbitMQ consumers not running  
**Fix:**
```bash
# Check RabbitMQ connections
http://localhost:15672 â†’ Connections tab

# Restart consumers
docker-compose restart comm-service-worker
```

---

## âœ… Complete Test Checklist

- [ ] All services healthy in `docker-compose ps`
- [ ] All services registered in Consul UI
- [ ] Created encadrant + student users
- [ ] Created profiles for both users
- [ ] Encadrant can create offers (Student cannot - 403)
- [ ] Encadrant publishes offer
- [ ] Student can apply to offer
- [ ] Encadrant accepts application
- [ ] Affectation auto-created
- [ ] AttendanceSummary auto-created
- [ ] Student marks attendance
- [ ] Student submits evaluation
- [ ] Encadrant validates evaluation (Student cannot - 403)
- [ ] All events appear in consumer logs
- [ ] RabbitMQ dashboard shows message flow

---

## ğŸ‰ Success!

**If all checkboxes are checked, your complete microservices system is working perfectly!**

Services are communicating via Consul, events flowing through RabbitMQ, RBAC protecting endpoints, and JWT authenticating all requests! ğŸš€
